{"ast":null,"code":"/**\n * Copyright (c) 2022\n *\n * Embed a ThoughtSpot Liveboard or visualization\n * https://developers.thoughtspot.com/docs/?pageid=embed-pinboard\n * https://developers.thoughtspot.com/docs/?pageid=embed-a-viz\n *\n * @summary Liveboard & visualization embed\n * @author Ayon Ghosh <ayon.ghosh@thoughtspot.com>\n */\nimport { ERROR_MESSAGE } from '../errors';\nimport { EmbedEvent, Param } from '../types';\nimport { getFilterQuery, getQueryParamString } from '../utils';\nimport { V1Embed } from './ts-embed';\n/**\n * Embed a ThoughtSpot Liveboard or visualization\n * @Category Liveboards and Charts\n */\n\nexport class LiveboardEmbed extends V1Embed {\n  // eslint-disable-next-line no-useless-constructor\n  constructor(domSelector, viewConfig) {\n    super(domSelector, viewConfig);\n    this.defaultHeight = 500;\n    /**\n     * Set the iframe height as per the computed height received\n     * from the ThoughtSpot app.\n     * @param data The event payload\n     */\n\n    this.updateIFrameHeight = data => {\n      this.setIFrameHeight(Math.max(data.data, this.defaultHeight));\n    };\n\n    this.embedIframeCenter = (data, responder) => {\n      const obj = this.getIframeCenter();\n      responder({\n        type: EmbedEvent.EmbedIframeCenter,\n        data: obj\n      });\n    };\n\n    this.setIframeHeightForNonEmbedLiveboard = data => {\n      if (!data.data.currentPath.startsWith('/embed/viz/')) {\n        this.setIFrameHeight(this.defaultHeight);\n      }\n    };\n  }\n  /**\n   * Construct a map of params to be passed on to the\n   * embedded Liveboard or visualization.\n   */\n\n\n  getEmbedParams() {\n    const params = this.getBaseQueryParams();\n    const {\n      enableVizTransformations,\n      fullHeight,\n      defaultHeight,\n      visibleVizs,\n      liveboardV2 = false,\n      vizId,\n      activeTabId\n    } = this.viewConfig;\n    const preventLiveboardFilterRemoval = this.viewConfig.preventLiveboardFilterRemoval || this.viewConfig.preventPinboardFilterRemoval;\n\n    if (fullHeight === true) {\n      params[Param.fullHeight] = true;\n    }\n\n    if (defaultHeight) {\n      this.defaultHeight = defaultHeight;\n    }\n\n    if (enableVizTransformations !== undefined) {\n      params[Param.EnableVizTransformations] = enableVizTransformations.toString();\n    }\n\n    if (preventLiveboardFilterRemoval) {\n      params[Param.preventLiveboardFilterRemoval] = true;\n    }\n\n    if (visibleVizs) {\n      params[Param.visibleVizs] = visibleVizs;\n    }\n\n    params[Param.livedBoardEmbed] = true;\n\n    if (vizId) {\n      params[Param.vizEmbed] = true;\n    }\n\n    params[Param.LiveboardV2Enabled] = liveboardV2;\n    const queryParams = getQueryParamString(params, true);\n    return queryParams;\n  }\n  /**\n   * Construct the URL of the embedded ThoughtSpot Liveboard or visualization\n   * to be loaded within the iframe.\n   * @param liveboardId The GUID of the Liveboard.\n   * @param vizId The optional GUID of a visualization within the Liveboard.\n   * @param runtimeFilters A list of runtime filters to be applied to\n   * the Liveboard or visualization on load.\n   */\n\n\n  getIFrameSrc(liveboardId, vizId, runtimeFilters, activeTabId) {\n    const filterQuery = getFilterQuery(runtimeFilters || []);\n    const queryParams = this.getEmbedParams();\n    const queryString = [filterQuery, queryParams].filter(Boolean).join('&');\n    let url = `${this.getV1EmbedBasePath(queryString, true, false, false)}/viz/${liveboardId}`;\n\n    if (activeTabId) {\n      url = `${url}/tab/${activeTabId}`;\n    }\n\n    if (vizId) {\n      url = `${url}/${vizId}`;\n    }\n\n    const tsPostHashParams = this.getThoughtSpotPostUrlParams();\n    url = `${url}${tsPostHashParams}`;\n    return url;\n  }\n  /**\n   * Triggers an event to the embedded app\n   * @param messageType The event type\n   * @param data The payload to send with the message\n   */\n\n\n  trigger(messageType) {\n    let data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    const dataWithVizId = data;\n\n    if (this.viewConfig.vizId) {\n      dataWithVizId.vizId = this.viewConfig.vizId;\n    }\n\n    return super.trigger(messageType, dataWithVizId);\n  }\n  /**\n   * Render an embedded ThoughtSpot Liveboard or visualization\n   * @param renderOptions An object specifying the Liveboard ID,\n   * visualization ID and the runtime filters.\n   */\n\n\n  render() {\n    var _a;\n\n    const {\n      vizId,\n      activeTabId,\n      runtimeFilters\n    } = this.viewConfig;\n    const liveboardId = (_a = this.viewConfig.liveboardId) !== null && _a !== void 0 ? _a : this.viewConfig.pinboardId;\n\n    if (!liveboardId) {\n      this.handleError(ERROR_MESSAGE.LIVEBOARD_VIZ_ID_VALIDATION);\n    }\n\n    if (this.viewConfig.fullHeight === true) {\n      this.on(EmbedEvent.RouteChange, this.setIframeHeightForNonEmbedLiveboard);\n      this.on(EmbedEvent.EmbedHeight, this.updateIFrameHeight);\n      this.on(EmbedEvent.EmbedIframeCenter, this.embedIframeCenter);\n    }\n\n    super.render();\n    const src = this.getIFrameSrc(liveboardId, vizId, runtimeFilters, activeTabId);\n    this.renderV1Embed(src);\n    return this;\n  }\n\n}\n/**\n * @hidden\n */\n\nexport class PinboardEmbed extends LiveboardEmbed {}","map":{"version":3,"mappings":"AAAA;;;;;;;;;;AAWA,SAASA,aAAT,QAA8B,WAA9B;AACA,SACIC,UADJ,EAGIC,KAHJ,QAOO,UAPP;AAQA,SAASC,cAAT,EAAyBC,mBAAzB,QAAoD,UAApD;AACA,SAASC,OAAT,QAAoC,YAApC;AAoEA;;;;;AAIA,OAAM,MAAOC,cAAP,SAA8BD,OAA9B,CAAqC;EAKvC;EACAE,YAAYC,WAAZ,EAAsCC,UAAtC,EAAqE;IACjE,MAAMD,WAAN,EAAmBC,UAAnB;IAJI,qBAAgB,GAAhB;IA4FR;;;;;;IAKQ,0BAAsBC,IAAD,IAAyB;MAClD,KAAKC,eAAL,CAAqBC,IAAI,CAACC,GAAL,CAASH,IAAI,CAACA,IAAd,EAAoB,KAAKI,aAAzB,CAArB;IACH,CAFO;;IAIA,yBAAoB,CAACJ,IAAD,EAAuBK,SAAvB,KAAyC;MACjE,MAAMC,GAAG,GAAG,KAAKC,eAAL,EAAZ;MACAF,SAAS,CAAC;QAAEG,IAAI,EAAEjB,UAAU,CAACkB,iBAAnB;QAAsCT,IAAI,EAAEM;MAA5C,CAAD,CAAT;IACH,CAHO;;IAKA,2CAAuCN,IAAD,IAAyB;MACnE,IAAI,CAACA,IAAI,CAACA,IAAL,CAAUU,WAAV,CAAsBC,UAAtB,CAAiC,aAAjC,CAAL,EAAsD;QAClD,KAAKV,eAAL,CAAqB,KAAKG,aAA1B;MACH;IACJ,CAJO;EArGP;EAED;;;;;;EAIQQ,cAAc;IAClB,MAAMC,MAAM,GAAG,KAAKC,kBAAL,EAAf;IACA,MAAM;MACFC,wBADE;MAEFC,UAFE;MAGFZ,aAHE;MAIFa,WAJE;MAKFC,WAAW,GAAG,KALZ;MAMFC,KANE;MAOFC;IAPE,IAQF,KAAKrB,UART;IAUA,MAAMsB,6BAA6B,GAC/B,KAAKtB,UAAL,CAAgBsB,6BAAhB,IACA,KAAKtB,UAAL,CAAgBuB,4BAFpB;;IAIA,IAAIN,UAAU,KAAK,IAAnB,EAAyB;MACrBH,MAAM,CAACrB,KAAK,CAACwB,UAAP,CAAN,GAA2B,IAA3B;IACH;;IACD,IAAIZ,aAAJ,EAAmB;MACf,KAAKA,aAAL,GAAqBA,aAArB;IACH;;IACD,IAAIW,wBAAwB,KAAKQ,SAAjC,EAA4C;MACxCV,MAAM,CACFrB,KAAK,CAACgC,wBADJ,CAAN,GAEIT,wBAAwB,CAACU,QAAzB,EAFJ;IAGH;;IACD,IAAIJ,6BAAJ,EAAmC;MAC/BR,MAAM,CAACrB,KAAK,CAAC6B,6BAAP,CAAN,GAA8C,IAA9C;IACH;;IACD,IAAIJ,WAAJ,EAAiB;MACbJ,MAAM,CAACrB,KAAK,CAACyB,WAAP,CAAN,GAA4BA,WAA5B;IACH;;IACDJ,MAAM,CAACrB,KAAK,CAACkC,eAAP,CAAN,GAAgC,IAAhC;;IACA,IAAIP,KAAJ,EAAW;MACPN,MAAM,CAACrB,KAAK,CAACmC,QAAP,CAAN,GAAyB,IAAzB;IACH;;IACDd,MAAM,CAACrB,KAAK,CAACoC,kBAAP,CAAN,GAAmCV,WAAnC;IACA,MAAMW,WAAW,GAAGnC,mBAAmB,CAACmB,MAAD,EAAS,IAAT,CAAvC;IAEA,OAAOgB,WAAP;EACH;EAED;;;;;;;;;;EAQQC,YAAY,CAChBC,WADgB,EAEhBZ,KAFgB,EAGhBa,cAHgB,EAIhBZ,WAJgB,EAII;IAEpB,MAAMa,WAAW,GAAGxC,cAAc,CAACuC,cAAc,IAAI,EAAnB,CAAlC;IACA,MAAMH,WAAW,GAAG,KAAKjB,cAAL,EAApB;IACA,MAAMsB,WAAW,GAAG,CAACD,WAAD,EAAcJ,WAAd,EACfM,MADe,CACRC,OADQ,EAEfC,IAFe,CAEV,GAFU,CAApB;IAGA,IAAIC,GAAG,GAAG,GAAG,KAAKC,kBAAL,CACTL,WADS,EAET,IAFS,EAGT,KAHS,EAIT,KAJS,CAKZ,QAAQH,WAAW,EALpB;;IAMA,IAAIX,WAAJ,EAAiB;MACbkB,GAAG,GAAG,GAAGA,GAAG,QAAQlB,WAAW,EAA/B;IACH;;IACD,IAAID,KAAJ,EAAW;MACPmB,GAAG,GAAG,GAAGA,GAAG,IAAInB,KAAK,EAArB;IACH;;IAED,MAAMqB,gBAAgB,GAAG,KAAKC,2BAAL,EAAzB;IACAH,GAAG,GAAG,GAAGA,GAAG,GAAGE,gBAAgB,EAA/B;IAEA,OAAOF,GAAP;EACH;EAsBD;;;;;;;EAKOI,OAAO,CAACC,WAAD,EAAuC;IAAA,IAAd3C,IAAc,uEAAF,EAAE;IACjD,MAAM4C,aAAa,GAAG5C,IAAtB;;IACA,IAAI,KAAKD,UAAL,CAAgBoB,KAApB,EAA2B;MACvByB,aAAa,CAACzB,KAAd,GAAsB,KAAKpB,UAAL,CAAgBoB,KAAtC;IACH;;IACD,OAAO,MAAMuB,OAAN,CAAcC,WAAd,EAA2BC,aAA3B,CAAP;EACH;EAED;;;;;;;EAKOC,MAAM;;;IACT,MAAM;MAAE1B,KAAF;MAASC,WAAT;MAAsBY;IAAtB,IAAyC,KAAKjC,UAApD;IACA,MAAMgC,WAAW,GACb,WAAKhC,UAAL,CAAgBgC,WAAhB,MAA2B,IAA3B,IAA2Be,aAA3B,GAA2BA,EAA3B,GAA+B,KAAK/C,UAAL,CAAgBgD,UADnD;;IAGA,IAAI,CAAChB,WAAL,EAAkB;MACd,KAAKiB,WAAL,CAAiB1D,aAAa,CAAC2D,2BAA/B;IACH;;IAED,IAAI,KAAKlD,UAAL,CAAgBiB,UAAhB,KAA+B,IAAnC,EAAyC;MACrC,KAAKkC,EAAL,CACI3D,UAAU,CAAC4D,WADf,EAEI,KAAKC,mCAFT;MAIA,KAAKF,EAAL,CAAQ3D,UAAU,CAAC8D,WAAnB,EAAgC,KAAKC,kBAArC;MACA,KAAKJ,EAAL,CAAQ3D,UAAU,CAACkB,iBAAnB,EAAsC,KAAK8C,iBAA3C;IACH;;IAED,MAAMV,MAAN;IAEA,MAAMW,GAAG,GAAG,KAAK1B,YAAL,CACRC,WADQ,EAERZ,KAFQ,EAGRa,cAHQ,EAIRZ,WAJQ,CAAZ;IAMA,KAAKqC,aAAL,CAAmBD,GAAnB;IAEA,OAAO,IAAP;EACH;;AAlKsC;AAqK3C;;;;AAGA,OAAM,MAAOE,aAAP,SAA6B9D,cAA7B,CAA2C","names":["ERROR_MESSAGE","EmbedEvent","Param","getFilterQuery","getQueryParamString","V1Embed","LiveboardEmbed","constructor","domSelector","viewConfig","data","setIFrameHeight","Math","max","defaultHeight","responder","obj","getIframeCenter","type","EmbedIframeCenter","currentPath","startsWith","getEmbedParams","params","getBaseQueryParams","enableVizTransformations","fullHeight","visibleVizs","liveboardV2","vizId","activeTabId","preventLiveboardFilterRemoval","preventPinboardFilterRemoval","undefined","EnableVizTransformations","toString","livedBoardEmbed","vizEmbed","LiveboardV2Enabled","queryParams","getIFrameSrc","liveboardId","runtimeFilters","filterQuery","queryString","filter","Boolean","join","url","getV1EmbedBasePath","tsPostHashParams","getThoughtSpotPostUrlParams","trigger","messageType","dataWithVizId","render","_a","pinboardId","handleError","LIVEBOARD_VIZ_ID_VALIDATION","on","RouteChange","setIframeHeightForNonEmbedLiveboard","EmbedHeight","updateIFrameHeight","embedIframeCenter","src","renderV1Embed","PinboardEmbed"],"sourceRoot":"","sources":["../../../src/embed/liveboard.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}